<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>stoner • stoner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="stoner">
<meta property="og:description" content="stoner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stoner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.13</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/stoner.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/vimc/stoner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="stoner_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>stoner</h1>
                        <h4 data-toc-skip class="author">Wes Hinsley</h4>
            
            <h4 data-toc-skip class="date">2022-10-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/vimc/stoner/blob/HEAD/vignettes/stoner.Rmd" class="external-link"><code>vignettes/stoner.Rmd</code></a></small>
      <div class="hidden name"><code>stoner.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>stoner</code> is a package to help with various tasks involving VIMC touchstones. Its purpose is evolving somewhat with the needs of the VIMC project; stoner is becoming an umbrella to keep these needs expressed in a tested package. As such, it can be used in a number of modes.</p>
</div>
<div class="section level2">
<h2 id="touchstone-creation-as-a-dettl-helper">Touchstone creation as a dettl helper<a class="anchor" aria-label="anchor" href="#touchstone-creation-as-a-dettl-helper"></a>
</h2>
<p>Creation of touchstones is quite a common process, although new touchstones will often be based on a previous one. However, creating the touchstone involves additions to various related tables, so the code to create touchstones is not always trivial to review.</p>
<p><a href="https://github.com/vimc/dettl" class="external-link">Dettl</a> has somewhat helped here, encouraging separation of extract, transform and load stages of an import, with testing of each stage, forcing the code for touchstone creation to be written in a way that separates those concerns and makes reviewing easier. Furthermore, it has often been possible to review a new import as a diff to a previously reviewed import.</p>
<p>Stoner takes this a step further by allowing the touchstone creation to be expressed in csv meta-data, providing function calls for the extract, transform and load stages.</p>
<div class="section level3">
<h3 id="the-r-code">The R code<a class="anchor" aria-label="anchor" href="#the-r-code"></a>
</h3>
<p>The code for a stoner touchstone import is very simple. Dettl requires that we write extract, transform, and load functions, and tests for the extract and load. So we create a dettl import as usual (see <code>dettl::dettl_new</code>), which begins a new import in our imports repo.</p>
<p>Dettl requires us to write various functions, which we can satisfy with single line functions for a start.</p>
<table class="table">
<colgroup>
<col width="41%">
<col width="58%">
</colgroup>
<thead><tr class="header">
<th align="left">Dettl.function</th>
<th align="left">Stoner.call</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">extract(con)</td>
<td align="left">stoner::stone_extract(‘.’, con)</td>
</tr>
<tr class="even">
<td align="left">test-extract(extracted_data)</td>
<td align="left">stoner::stone_test_extract(extracted_data)</td>
</tr>
<tr class="odd">
<td align="left">transform(extracted_data)</td>
<td align="left">stoner::stone_transform(extracted_data)</td>
</tr>
<tr class="even">
<td align="left">test-transform(transformed_data)</td>
<td align="left">stoner::stone_test_transform(transformed_data)</td>
</tr>
<tr class="odd">
<td align="left">load(transformed_data, con)</td>
<td align="left">stoner::stone_load(transformed_data, con)</td>
</tr>
</tbody>
</table>
<p>So for the minimal example, when writing the dettl import, delegate each of dettl’s functions to the stoner handlers, passing the same arguments.</p>
</div>
<div class="section level3">
<h3 id="the-csv-files-for-the-import">The CSV files for the Import<a class="anchor" aria-label="anchor" href="#the-csv-files-for-the-import"></a>
</h3>
<p>The minimal example on its own will do nothing and exit cleanly. To make stoner do some useful work, we write csv files in a folder called <code>meta</code> within the import folder. These csv files should be thought of a specification of “how you would like things to be” - rather than “what you want stoner to do”. If rows in your csv file identically exist in the database, stoner will use the existing ones and not add duplicates. If the rows in your csv are provably absent from the database, stoner will add new ones.</p>
<p>If stoner detects in some way that the items already exist, but not all csv data matches with those items, then some other factors come into play that affect whether stoner can update the database content or not. Imports are <em>incremental</em> to the database, yet on some occasions, it is useful to be able to do in-place edits of touchstones that are still in preparation, for example.</p>
<p>Following are the csv files that stoner will recognise, and their columns and formats, and notes on the requirements. Any failure to meet the requirements will cause an abort with an error message.</p>
<p>You do not have to provide all of the csvs, only ones where you expect something to change, but you may find it good practice to “over-specify”, since the result is that Stoner will check the database tables are all as you expect. It also may be helpful to be able to compare complete touchstone definitions (ie, sets of stoner csv files) as a diff between two imports.</p>
<div class="section level4">
<h4 id="touchstone_name-csv">touchstone_name.csv<a class="anchor" aria-label="anchor" href="#touchstone_name-csv"></a>
</h4>
<p>A <code>touchstone_name</code> refers to a broad ensemble of closely related runs; there will be at least one version for each touchstone_name, and it is the specific version that we colloquially refer to as ‘a touchstone’.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">id</td>
<td align="left"><code>201910gavi</code></td>
</tr>
<tr class="even">
<td align="left">description</td>
<td align="left"><code>October 2019 touchstone</code></td>
</tr>
<tr class="odd">
<td align="left">comment</td>
<td align="left"><code>Standard GAVI</code></td>
</tr>
</tbody>
</table>
<ul>
<li>If the <code>id</code> is not found in the <code>touchstone_name</code> db table, then the row is added.</li>
<li>If the <code>id</code> is found, and <code>description</code> and <code>comment</code> match, then the row in the csv is ignored.</li>
<li>If, a <code>touchstone_name</code> with that <code>id</code> exists, but <code>description</code> and/or <code>comment</code> differ from the original, then the fields in the database are updated in-place if either:
<ul>
<li>There are no versions of that touchstone yet, OR</li>
<li>
<strong>All</strong> existing versions of that touchstone have status <code>in-preparation</code>.</li>
<li>Otherwise: an error occurs and the import aborts.</li>
</ul>
</li>
<li>
<code>Description</code> and <code>Comment</code> must be non-empty. Conventionally, <code>description</code> has been used to describe the date and basic purpose, and <code>comment</code> for any further detail required.</li>
</ul>
</div>
<div class="section level4">
<h4 id="touchstone-csv">touchstone.csv<a class="anchor" aria-label="anchor" href="#touchstone-csv"></a>
</h4>
<p>A <code>touchstone</code> is a particular version of a <code>touchstone_name</code>, and is the basic unit of currency for touchstones in Montagu. Coverage, expectations and burden estimates are all attached to one of these versioned touchstones.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">id</td>
<td align="left"><code>201910gavi-1</code></td>
</tr>
<tr class="even">
<td align="left">touchstone_name</td>
<td align="left"><code>201910gavi</code></td>
</tr>
<tr class="odd">
<td align="left">version</td>
<td align="left"><code>1</code></td>
</tr>
<tr class="even">
<td align="left">status</td>
<td align="left">
<code>in-preparation</code>, <code>open</code> or <code>finished</code>
</td>
</tr>
<tr class="odd">
<td align="left">description</td>
<td align="left"><code>201910gavi (version 1)</code></td>
</tr>
<tr class="even">
<td align="left">comment</td>
<td align="left"><code>GAVI Version 1</code></td>
</tr>
</tbody>
</table>
<ul>
<li>
<code>id</code> must be in the form <code>touchstone_name</code>-<code>version</code>.</li>
<li>
<code>touchstone_name</code> must match a <code>touchstone_name.id</code>, either in the database, or in the accompanying <code>touchstone_name.csv</code>
</li>
<li>If touchstone <code>id</code> is not found, then stoner will add the new row.</li>
<li>If touchstone <code>id</code> is found and all other columns match, stoner ignores it.</li>
<li>If touchstone <code>id</code> is found, but any other column differs, then stoner will update the fields in the existing touchstone only if its status is <code>in-preparation</code>. Otherwise, it will fail with an error.</li>
<li>
<code>description</code> and <code>comment</code> must be non-empty. Typically, <code>description</code> has been very minimal about the existence of the touchstone, and <code>comments</code> to record more details about why the touchstone version exists.</li>
</ul>
</div>
<div class="section level4">
<h4 id="touchstone_countries-csv">touchstone_countries.csv<a class="anchor" aria-label="anchor" href="#touchstone_countries-csv"></a>
</h4>
<p>The <code>touchstone_country</code> table in the database should really be called <code>touchstone_country_disease</code>. For a given touchstone, it records which countries should be returned when groups download their demographic data. This might differ from the countries a group is expected to model for a certain touchstone; see the responsibilities.csv section for that.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">touchstone</td>
<td align="left"><code>201910gavi-1</code></td>
</tr>
<tr class="even">
<td align="left">disease</td>
<td align="left"><code>Measles;MenA</code></td>
</tr>
<tr class="odd">
<td align="left">country</td>
<td align="left"><code>AFG;BEN;IND;ZWE</code></td>
</tr>
</tbody>
</table>
<ul>
<li>This is an incremental update; if any row in the csv does not exactly match one in the database table, a new row will be added. Exact duplicates will be ignored.</li>
<li>It is not currently possible to remove rows in the database, or to edit existing ones.</li>
<li>The touchstone <code>id</code> must exist in the database already, or in the <code>touchstone.csv</code> file included in your import.</li>
<li>Semi-colon separated lists are acceptable for the disease and country, since several diseases share the same list of relevant countries.</li>
<li>All diseases must be found in the <code>id</code> field of the <code>disease</code> table. Stoner cannot currently add new diseases.</li>
<li>All countries must be found in the <code>id</code> column of the <code>country</code> table. Stoner cannot currently add new countries, but the <code>country</code> table should be complete.</li>
<li>TO-DO: It looks like we can do this to touchstones that are not in-prep.</li>
</ul>
</div>
<div class="section level4">
<h4 id="touchstone_demographic_dataset-csv">touchstone_demographic_dataset.csv<a class="anchor" aria-label="anchor" href="#touchstone_demographic_dataset-csv"></a>
</h4>
<p>The touchstone_demographic_dataset table determines which demographic_statistic_types from which demographic_source will be used when providing demographic data for a particular touchstone. Generally, there will be a new demographic source each year, when either the IGME child mortality data, or the UNWPP population data, or both get updated. Because these updates happen at different times (UNWPP bi-yearly, and IGME yearly), sometimes a touchstone_demographic_dataset might incorporate fields from different sources, hence this table.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">demographic_source</td>
<td align="left"><code>dds-201910_2</code></td>
</tr>
<tr class="even">
<td align="left">demographic_statistic_type</td>
<td align="left"><code>int_pop</code></td>
</tr>
<tr class="odd">
<td align="left">touchstone</td>
<td align="left"><code>201910gavi-1</code></td>
</tr>
</tbody>
</table>
<ul>
<li>
<code>demographic_statistic_type</code> and <code>demographic_source</code> are strings, that must exist in the <code>code</code> column of the respective database tables.</li>
<li>The touchstone <code>id</code> must exist in the database already, or in the <code>touchstone.csv</code> file included in your import.</li>
<li>Updates here are incremental only; non-matching rows will be added, and exact matches will be ignored. Stoner cannot remove or edit existing entries.</li>
<li>TO-DO: It looks like we can do this to touchstones that are not in-prep.</li>
</ul>
</div>
<div class="section level4">
<h4 id="scenario_type-csv">scenario_type.csv<a class="anchor" aria-label="anchor" href="#scenario_type-csv"></a>
</h4>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">id</td>
<td align="left"><code>stop</code></td>
</tr>
<tr class="even">
<td align="left">name</td>
<td align="left"><code>VIMC stop scenario</code></td>
</tr>
</tbody>
</table>
<ul>
<li>If the scenario_type <code>id</code> is not found in the database table, then new rows will be added.</li>
<li>If the scenario_type <code>id</code> is found in the database table, and the name matches that in your csv file, then the row is ignored.</li>
<li>If the <code>id</code> exists, but the <code>name</code> differs then:-
<ul>
<li>If there are no scenario_descriptions referring to this <code>id</code>, the <code>name</code> in the database table for this id will be updated.</li>
<li>If there are scenario_descriptions referring to this <code>id</code>, then stoner looks up the status of any touchstones that refer to that scenario_description, and will only perform the update if all are in the <code>in-preparation</code> state.</li>
<li>
<strong>However</strong>, you can override this requirement by using this in your load phase:- <br><p style="font-size:0.8em">
   <code>stoner::stone_load(transformed_data, con, allow_overwrite_scenario_type = TRUE)</code>
</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="scenario_description-csv">scenario_description.csv<a class="anchor" aria-label="anchor" href="#scenario_description-csv"></a>
</h4>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">id</td>
<td align="left"><code>mena-routine-no-vaccination</code></td>
</tr>
<tr class="even">
<td align="left">description</td>
<td align="left"><code>Description free text</code></td>
</tr>
<tr class="odd">
<td align="left">disease</td>
<td align="left"><code>MenA</code></td>
</tr>
<tr class="even">
<td align="left">scenario_type</td>
<td align="left"><code>stop</code></td>
</tr>
</tbody>
</table>
<ul>
<li>
<code>id</code> has conventionally been in lower-case, and in the form <code>disease-coverage_type</code>.</li>
<li>If the scenario_description <code>id</code> does not exist in the database, stoner will add the new scenario_description.</li>
<li>If the scenario_description <code>id</code> exists, and all other columns match the existing values too, then the row is ignored. If the <code>id</code> exists, but other columns differ, then:
<ul>
<li>If any <code>scenario</code> exists that refers to this <code>scenario_description</code>, and the touchstone associated with that scenario is not in the <code>in-preparation</code> state, then the import fails with an error.</li>
<li>
<strong>However</strong>, on occasion it has been desirable to change the description of a scenario while a touchstone referring to it is open. To override the <code>in-preparation</code> requirement, in the load phase of the import, use: <br><p style="font-size:0.8em">
   <code>stoner::stone_load(transformed_data, con, allow_overwrite_scenario_description = TRUE)</code>
</p>
</li>
</ul>
</li>
<li>
<code>disease</code> must currently be one of <code>Cholera</code>, <code>HepB</code>, <code>Hib</code>, <code>HPV</code>, <code>JE</code>, <code>Measles</code>, <code>MenA</code>, <code>PCV</code>, <code>Rota</code>, <code>Rubella</code>, <code>Typhoid</code> or <code>YF</code>. These match the <code>id</code> column of the <code>disease</code> table. Stoner cannot currently add new diseases; this is an admin task done separately.</li>
<li>
<code>scenario_type</code> must be the <code>id</code> of a <code>scenario_type</code>, either in the database table, or in a <code>scenario_type.csv</code> as part of your import.</li>
</ul>
</div>
<div class="section level4">
<h4 id="responsibilities-csv">responsibilities.csv<a class="anchor" aria-label="anchor" href="#responsibilities-csv"></a>
</h4>
<p>Most of the work for implementing a touchstone is done here, in which we add the scenario, responsibility and expectations (including countries and outcomes) that form the tasks different groups must perform.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">modelling_group</td>
<td align="left"><code>IC-Hallet</code></td>
</tr>
<tr class="even">
<td align="left">disease</td>
<td align="left"><code>HepB</code></td>
</tr>
<tr class="odd">
<td align="left">touchstone</td>
<td align="left"><code>201910gavi-1</code></td>
</tr>
<tr class="even">
<td align="left">scenario</td>
<td align="left"><code>hepb-no-vaccination;hepb-bd-routine-bestcase</code></td>
</tr>
<tr class="odd">
<td align="left">scenario_type</td>
<td align="left"><code>standard</code></td>
</tr>
<tr class="even">
<td align="left">age_min_inclusive</td>
<td align="left"><code>0</code></td>
</tr>
<tr class="odd">
<td align="left">age_max_inclusive</td>
<td align="left"><code>99</code></td>
</tr>
<tr class="even">
<td align="left">cohort_min_inclusive</td>
<td align="left"><code>1901</code></td>
</tr>
<tr class="odd">
<td align="left">cohort_max_inclusive</td>
<td align="left"><code>2100</code></td>
</tr>
<tr class="even">
<td align="left">year_min_inclusive</td>
<td align="left"><code>2000</code></td>
</tr>
<tr class="odd">
<td align="left">year_max_inclusive</td>
<td align="left"><code>2100</code></td>
</tr>
<tr class="even">
<td align="left">countries</td>
<td align="left"><code>AFG;BEN;COD</code></td>
</tr>
<tr class="odd">
<td align="left">outcomes</td>
<td align="left"><code>dalys;deaths;cases</code></td>
</tr>
</tbody>
</table>
<ul>
<li><p>The <code>modelling_group</code> must match an <code>id</code> of the <code>modelling_group</code> table. Stoner can’t add new modelling groups.</p></li>
<li><p>The <code>disease</code> must match an <code>id</code> of the <code>disease</code> table. Stoner can’t add new diseases either.</p></li>
<li><p>The <code>touchstone</code> must exist either in the <code>touchstone</code> table, or in the <code>touchstone.csv</code> as part of your import.</p></li>
<li><p><code>scenario</code> here is a semi-colon separated list of scenarios - which are actually <code>scenario_description</code> ids. The matching description must exist in either the <code>scenario_description</code> table, or <code>scenario_description.csv</code> in your import.</p></li>
<li><p>The minimum and maximum ages, cohorts and years above are implying that this group should provide ages 0-99 inclusive, for calendar years 2000-2100. The 99 year olds in 2000 were born in 1901, so this is the minimum cohort, whereas the maximum cohort will be the last year in which people were born, which will be the 0-year olds in 2100.</p></li>
<li><p>All countries must be found in the <code>id</code> column of the <code>country</code> table. Stoner cannot currently add new countries, but the <code>country</code> table should be complete.</p></li>
<li>
<p>All outcomes must be found in the <code>code</code> column of the burden_outcome` table. Stoner cannot currently add new burden outcomes.</p>
<p>The <code>responsibilities.csv</code> file may cause changes to the <code>scenario</code>, <code>responsibility_set</code>, <code>responsibility</code>, <code>burden_estimate_expectation</code>, <code>burden_estimate_country_expectation</code> and <code>burden_estimate_outcome_expectation</code> tables. Where possible, existing rows are re-used, rather than creating duplicates.</p>
</li>
<li>
<p><strong>scenario table</strong></p>
<ul>
<li>A <code>scenario</code> is defined by <code>scenario_description</code> and <code>touchstone</code>. If combinations of those exist in <code>responsibilities_csv</code> that aren’t in the <code>scenario</code> database table, then new rows get added.</li>
<li>scenarios can only be added currently when the touchstone has status <code>in-prep</code>.</li>
</ul>
</li>
<li>
<p><strong>responsibility_set table</strong></p>
<ul>
<li>
<code>responsibility_set</code> is defined by <code>modelling_group</code> and <code>touchstone</code>. If combinations exist in <code>responsibilities_csv</code> that aren’t in the database, they get created.</li>
<li>responsibility_sets can only be added currently when the touchstone has status <code>in-prep</code>.</li>
</ul>
</li>
<li>
<p><strong>burden_estimate_expectations table</strong></p>
<ul>
<li>This table contains the minimum and maximum ages, cohorts and years, for a given version (which is a <code>touchstone_name</code> - no version number), and a description, conventionally in the form <code>disease:group:scenario_type</code>, where the <code>scenario_type</code> might be a particular scenario (if expectations need to be specific to that scenario), or in many cases, then scenario_type has been defined as <code>standard</code>, allowing the same expectation definition to be shared for different scenarios (for a particular group and disease).</li>
<li>Stoner treats rows as already existing, if they match all of those fields exactly. If a matching row can be found, then that burden_estimate_expectation is reused, and its id is noted for the other tables below. Otherwise a new one is created, which will have a newly create id. Hence, it is possible for multiple responsibilities to have the same expectations - see below.</li>
<li>Stoner cannot remove or edit existing burden_estimate_expectations.</li>
<li>Expectations can only be added currently when the touchstone has status <code>in-prep</code>.</li>
</ul>
</li>
<li>
<p><strong>burden_estimate_country_expectation table</strong></p>
<ul>
<li>For a particular <code>burden_estimate_expectation</code>, the rows in the <code>burden_estimate_country_expectation</code> table list the countries for which we are expecting estimates to be uploaded by a particular group, for a particular disease, and a particular scenario.</li>
<li>The <code>burden_estimate_expectation</code> in this table is a numerical id, referring to either a newly created expectation as a result of your import, or an expectation that previous existed and matched the details exactly.</li>
<li>The table is increment-only; Stoner will add any (expectation, country) pairs from your responsibilities.csv file that aren’t in the table, and ignore those that are. Stoner cannot remove countries from the expectations.</li>
</ul>
</li>
<li>
<p><strong>burden_estimate_outcome_expectation table</strong></p>
<ul>
<li>Similar to the country expectations, the rows in the <code>burden_estimate_outcome_expectation</code> table list the expected outcomes that a group will upload for a particular scenario and disease.</li>
<li>The burden outcomes are listed in the <code>burden_outcome</code> table - but Stoner cannot change the contents of that table at present.</li>
<li>Again, this table is increment-only; Stoner will add any (expectation, country) pairs from your responsibilities.csv file that aren’t in the table, and ignore those that are. Stoner cannot remove countries from the expectations.</li>
</ul>
</li>
<li>
<p><strong>responsibility table</strong></p>
<ul>
<li>Finally, having created all the necessary rows, the responsibility table then links the following together:-
<ul>
<li>The responsibility_set it belongs to</li>
<li>The scenario it refers to</li>
<li>The burden_estimate_expectation (which in turn is linked to by the burden_estimate_outcome_expectation and burden_estimate_country_expectation tables)</li>
</ul>
</li>
<li>Responsibility rows can only be added when the touchstone has status <code>in-prep</code>.</li>
<li>The responsibility table also records <code>current_burden_estimate_set</code> and <code>current_stochastic_burden_estimate_set</code> - both of which are nullable, and are left at <code>NA</code> by default.</li>
<li>Finally, the responsibility_table has a flag <code>is_open</code>, which Stoner will set to TRUE as default.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="the-test-functions">The test functions<a class="anchor" aria-label="anchor" href="#the-test-functions"></a>
</h3>
<p>Firstly, have your <code>test-extract</code> call <code>stoner::stone_test_extract(extracted_data)</code>, and <code>test-transform</code> call <code>stoner::stone_test_transform(transformed_data)</code> for the built-in tests to be called. Most likely, there is nothing else useful you can write for these tests, if your extract and transform functions are simply calling Stoner’s.</p>
<p>Possibly the best approach to tests is to write the <code>test-queries</code> function for dettl in the following form:-</p>
<p style="font-size:0.6em">
</p>
<pre><code><span><span class="va">test_queries</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  tn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM touchstone"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  tddn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM touchstone_demographic_dataset"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  tcn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM touchstone_country"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  sdn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM scenario_description"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  sn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM scenario"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  been <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM burden_estimate_expectation"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  beoen <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM burden_estimate_outcome_expectation"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  becen <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM burden_estimate_country_expectation"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  rsn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM responsibility_set"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  rn <span class="op">=</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) FROM responsibility"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span><span class="op">}</span></span></code></pre>

<p>and a <code>test_load.R</code> that tests how many rows have been added, for example…</p>
<p style="font-size:0.6em">
</p>
<pre><code><span><span class="fu">context</span><span class="op">(</span><span class="st">"load"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html" class="external-link">test_that</a></span><span class="op">(</span><span class="st">"Expected rows added"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">tn</span>, <span class="va">before</span><span class="op">$</span><span class="va">tn</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">tddn</span>, <span class="va">before</span><span class="op">$</span><span class="va">tddn</span> <span class="op">+</span> <span class="fl">23</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">tcn</span>, <span class="va">before</span><span class="op">$</span><span class="va">tcn</span> <span class="op">+</span> <span class="fl">946</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">sdn</span>, <span class="va">before</span><span class="op">$</span><span class="va">sdn</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">sn</span>, <span class="va">before</span><span class="op">$</span><span class="va">sn</span> <span class="op">+</span> <span class="fl">67</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">been</span>, <span class="va">before</span><span class="op">$</span><span class="va">been</span> <span class="op">+</span> <span class="fl">26</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">beoen</span>, <span class="va">before</span><span class="op">$</span><span class="va">beoen</span> <span class="op">+</span> <span class="fl">128</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">becen</span>, <span class="va">before</span><span class="op">$</span><span class="va">becen</span> <span class="op">+</span> <span class="fl">2137</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">rsn</span>, <span class="va">before</span><span class="op">$</span><span class="va">rsn</span> <span class="op">+</span> <span class="fl">17</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">rn</span>, <span class="va">before</span><span class="op">$</span><span class="va">rn</span> <span class="op">+</span> <span class="fl">127</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>

<p>For this though, you will have to have prior knowledge about how many of the rows in your various CSV files exist already in the database, and how many you are expecting will need to be created.</p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-usage">Advanced usage<a class="anchor" aria-label="anchor" href="#advanced-usage"></a>
</h2>
<div class="section level3">
<h3 id="fast-forwarding">Fast-forwarding<a class="anchor" aria-label="anchor" href="#fast-forwarding"></a>
</h3>
<p>The need for fast-forwarding arises when the following events happen.</p>
<ul>
<li>Modelling groups upload burden estimates to a certain touchstone version.</li>
<li>A coverage issue is discovered that affects some groups.</li>
<li>A new touchstone version is created which fixes the coverage issue.</li>
<li>For unaffected groups (ie, coverage did not change for them), we may want their burden estimates to appear in the same touchstone version as the newer groups.</li>
</ul>
<p>Therefore, fast-forwarding is a process where burden estimates are moved from one touchstone to another - or more specifically, one responsibility_set to another (since responsibility_set is defined by modelling_group and touchstone).</p>
<div class="section level4">
<h4 id="what-fast-forwarding-does">What fast-forwarding does…<a class="anchor" aria-label="anchor" href="#what-fast-forwarding-does"></a>
</h4>
<p>Suppose then, that we the new touchstone ready, and we have, potentially, some burden estimate sets to migrate. Fast-forwarding would do the following. Let’s consider it first for a single scenario, and a single modelling_group.</p>
<ul>
<li><p>We specify that we want to fast-forward an existing burden estimate set for a certain modelling_group and scenario, from one touchstone to another. We’ll see how to specify that in a simple CSV file shortly. A stoner import running on that CSV file then does essentially the following:-</p></li>
<li>
<p>If necessary, create a new <code>responsibility_set</code> for the modelling_group, in the destination touchstone.</p>
<ul>
<li>If, on the other hand, a <code>responsibility_set</code> already exists, that’s fine, we’ll use the existing one.</li>
</ul>
</li>
<li>
<p>If necessary, create a new <code>responsibility</code> within the new <code>responsibility_set</code>, for the specified scenario.</p>
<ul>
<li>If a suitable <code>responsibility</code> already exists, but there is no burden estimate set associated with it, then we can continue using the existing <code>responsibility</code>.</li>
<li>If, though, a burden estimate does exist in that target <code>responsibility</code>, we abort and don’t fast forward.</li>
</ul>
</li>
<li><p>Fast-forwarding a burden_estimate_set then means copying the <code>current_burden_estimate_set</code> value from one responsibility to another; from the older into the newer, and setting the older to <code>NA</code>.</p></li>
<li><p>Additionally, when a new <code>responsibility_set</code> is created by stoner, it will copy the most recent <code>responsibility_set_comment</code> from the old, to the new <code>responsibility_set</code>, noting that the new one was created by fast-forwding.</p></li>
<li><p>For <code>responsibility_comment</code>s - if any work is done (either creating a new responsibility, or setting <code>current_burden_estimate_set</code> on the new responsibility for the first time, then the most recent <code>responsibility_comment</code> (if there is one) will be copied to the new responsibility, with a note about fast-forwarding.</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="how-to-write-a-fast-forwarding-import">How to write a fast-forwarding import<a class="anchor" aria-label="anchor" href="#how-to-write-a-fast-forwarding-import"></a>
</h4>
<p>Write a <code>fast_forward.csv</code> file in the following form.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">modelling_group</td>
<td align="left">IC-Hallett;Li</td>
</tr>
<tr class="even">
<td align="left">scenario</td>
<td align="left">hepb-no-vaccination</td>
</tr>
<tr class="odd">
<td align="left">touchstone_from</td>
<td align="left">202110gavi-2</td>
</tr>
<tr class="even">
<td align="left">touchstone_to</td>
<td align="left">202110gavi-3</td>
</tr>
</tbody>
</table>
<ul>
<li><p>Note that fast-forwarding must be the only thing in the import, and the only .csv file in use. Combining fast-forwarding with other touchstone creation or management functions is too stressful to contemplate. Do them separate, and test them separately.</p></li>
<li><p>Also, while you can do fastforwarding for different touchstones in the same CSV, be careful with it as it gets confusing. Stoner will not let you fastforward into, and out of, the same touchstone (ie, from version 1 to 2, and 2 to 3) in the same CSV file.</p></li>
<li><p>The <code>modelling_group</code> and <code>scenario</code> columns can either be single items, with multiple rows in the csv file. Or, they can be semi-colon separated, to give multiple combinations of groups and scenarios. Finally, they can be wildcard <code>*</code> to match anything.</p></li>
<li><p>Include all the standard stoner one-lines, for the extract, test-extract, transform, test-transform, and load stages, as above, and ensure that in <code>dettl.yml</code> for the report, automatic loading is not enabled.</p></li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="pruning-burden-estimate-sets">Pruning burden estimate sets<a class="anchor" aria-label="anchor" href="#pruning-burden-estimate-sets"></a>
</h3>
<p>When modelling groups upload more than one burden estimate set for the same responsibility (that is, the same touchstone, scenario, disease), only the most recent is regarded as interesting, and is marked as the <code>current_burden_estimate_set</code> for the responsibility. To save space (for some groups, a considerable amount of space), the old orphaned burden estimate sets can be deleted.</p>
<p>Note that this should be considered a “final” delete; rows will be dropped from the <code>burden_estimate_set</code> table, and especially the <code>burden_estimate</code> table. While rolling the database back via backups is possible, it’s not desirable. That said, there should be no reason to keep previous versions of a burden estimate set. If both the old and new versions are important, they should both be “current” burden estimate sets, in different touchstones or reponsibilities perhaps.</p>
<div class="section level4">
<h4 id="how-to-write-a-prune-import">How to write a prune import<a class="anchor" aria-label="anchor" href="#how-to-write-a-prune-import"></a>
</h4>
<p>Write a <code>prune.csv</code> file in the following form.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Column</th>
<th align="left">Example</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">modelling_group</td>
<td align="left">IC-Hallett;Li</td>
</tr>
<tr class="even">
<td align="left">disease</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">scenario</td>
<td align="left">hepb-no-vaccination</td>
</tr>
<tr class="even">
<td align="left">touchstone</td>
<td align="left">202110gavi-2;202110gavi-3</td>
</tr>
</tbody>
</table>
<ul>
<li><p>Each field can be semi-colon-separated, and the result is that all possibilities are multipled out. (So in the above example, both touchstones, for both modelling groups will be examined for pruning opportunities).</p></li>
<li><p>You can also include multiple lines in the CSV file, which will be considered one at a time, thus allowing flexibility to look at a number of specific combinations for pruning.</p></li>
<li><p>The <code>*</code> is a wildcard, and in the simplest case, all the fields can be left as <code>*</code>, to look for pruning opportunities in the entire history of burden estimate sets.</p></li>
<li><p>Note that if <code>prune.csv</code> exists, no other <code>csv</code> file should be included - that is: a pruning import should just do pruning, and not any other functionality. This keeps things simple, which is a good thing since here we are (somewhat uniquely) performing a deletion of data.</p></li>
<li><p>Include all the standard stoner one-lines, for the extract, test-extract, transform, test-transform, and load stages, as above, and ensure that in <code>dettl.yml</code> for the report, automatic loading is not enabled.</p></li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 id="using-stoner-as-a-standalone-package-without-dettl">Using stoner as a standalone package (without Dettl)<a class="anchor" aria-label="anchor" href="#using-stoner-as-a-standalone-package-without-dettl"></a>
</h2>
<div class="section level3">
<h3 id="dumping-touchstones">Dumping touchstones<a class="anchor" aria-label="anchor" href="#dumping-touchstones"></a>
</h3>
<p><code>stoner::stone_dump(con, touchstone, path)</code>, called with a database connection, a touchstone, and an output path, will produce csv files of everything connected with that touchstone, in the form stoner would use to import, as described above. This might be useful if you want to download an existing touchstone, edit some details (including the touchstone id), and upload a modified version.</p>
</div>
<div class="section level3">
<h3 id="stochastic-processing">Stochastic processing<a class="anchor" aria-label="anchor" href="#stochastic-processing"></a>
</h3>
<p>Modelling groups submit stochastic data to VIMC by responding to a Dropbox File Request. A stochastic set consists of 200 runs for each scenario for that group, using a range of different parameters that are intended to capture the uncertainty in the model.</p>
<p>After some initial sanity checks (which are manual at present), the incoming csvs are compressed with <code>xz</code> with maximum settings, which provides the best compression for csvs, but fast decompression, and seamless decompression in R. (Windows command-line <code>xz -z -k -9 -e *.csv</code>)</p>
<p>The incoming stochastics are separated certainly by scenario, and may be further separated for convenience; some groups have provided a file per country, others a file per stochastic run. From these, we create four intermediate files for each group, which eliminate age by summing over a calendar year, summing over a birth cohort (year - age), and for each option, either including all ages, or filtering just ages 0 to 4. They include just the <code>cases</code>, <code>deaths</code> and <code>dalys</code> outcomes (which might be calculated by summing more detailed outcomes a group provides) for each scenario in columns. The idea is so that calculating impact between scenarios can then be calculated simply by doing maths on values from the same row of the file.</p>
<p>These four files are later uploaded to four separate tables on the annex database.</p>
<p>Note that the production of the intermediate files can take a few hours per group, whereas the upload to annex takes only a few minutes. Storing the intermediate files can be useful should we need to redeploy annex at any point.</p>
<p>Also note the examples below assume you have a connection to the production database (<code>con</code>), and later, a connection to the annex database (<code>annex</code>). See the end for notes on getting those connections in different ways.</p>
<div class="section level4">
<h4 id="simple-use">Simple Use<a class="anchor" aria-label="anchor" href="#simple-use"></a>
</h4>
<p>In the simplest case, a group uploads a single csv file per scenario as follows:-</p>
<table class="table">
<thead><tr class="header">
<th align="left">disease</th>
<th align="right">run_id</th>
<th align="right">year</th>
<th align="right">age</th>
<th align="left">country</th>
<th align="left">country_name</th>
<th align="right">cohort_size</th>
<th align="right">cases</th>
<th align="right">deaths</th>
<th align="right">dalys</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">YF</td>
<td align="right">1</td>
<td align="right">2000</td>
<td align="right">0</td>
<td align="left">AGO</td>
<td align="left">Angola</td>
<td align="right">677439</td>
<td align="right">59</td>
<td align="right">22</td>
<td align="right">1233</td>
</tr>
<tr class="even">
<td align="left">YF</td>
<td align="right">1</td>
<td align="right">2001</td>
<td align="right">0</td>
<td align="left">AGO</td>
<td align="left">Angola</td>
<td align="right">700540</td>
<td align="right">61</td>
<td align="right">23</td>
<td align="right">1390</td>
</tr>
<tr class="odd">
<td align="left">YF</td>
<td align="right">1</td>
<td align="right">2002</td>
<td align="right">0</td>
<td align="left">AGO</td>
<td align="left">Angola</td>
<td align="right">725742</td>
<td align="right">66</td>
<td align="right">24</td>
<td align="right">1330</td>
</tr>
<tr class="even">
<td align="left">YF</td>
<td align="right">1</td>
<td align="right">2003</td>
<td align="right">0</td>
<td align="left">AGO</td>
<td align="left">Angola</td>
<td align="right">753178</td>
<td align="right">69</td>
<td align="right">25</td>
<td align="right">1196</td>
</tr>
<tr class="odd">
<td align="left">YF</td>
<td align="right">1</td>
<td align="right">2004</td>
<td align="right">0</td>
<td align="left">AGO</td>
<td align="left">Angola</td>
<td align="right">782967</td>
<td align="right">71</td>
<td align="right">26</td>
<td align="right">1490</td>
</tr>
</tbody>
</table>
<p>which would continue for all the countries, years and ages, for 200 runs of a particular scenario. A separate file would exist for each scenario. To transform this into the four intermediate files, we might write below - where the argument names are included just for clarity, and are not needed.</p>
<pre><code><span>  <span class="fu"><a href="../reference/stone_stochastic_process.html">stone_stochastic_process</a></span><span class="op">(</span></span>
<span>    con <span class="op">=</span> <span class="va">con</span>,</span>
<span>    modelling_group <span class="op">=</span> <span class="st">"IC-Garske"</span>,</span>
<span>    disease <span class="op">=</span> <span class="st">"YF"</span>,</span>
<span>    touchstone <span class="op">=</span> <span class="st">"201910gavi-4"</span>,</span>
<span>    scenarios <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yf-no-vaccination"</span>, <span class="st">"yf-preventive-bestcase"</span>,</span>
<span>                  <span class="st">"yf-preventive-default"</span>, <span class="st">"yf-routine-bestcase"</span>,</span>
<span>                  <span class="st">"yf-routine-default"</span>, <span class="st">"yf-stop"</span><span class="op">)</span>,</span>
<span>    in_path <span class="op">=</span> <span class="st">"E:/Dropbox/File Requests/IC-Garske"</span>,</span>
<span>    file <span class="op">=</span> <span class="st">":scenario.csv.xz"</span>,</span>
<span>    cert <span class="op">=</span> <span class="st">"certfile"</span>,</span>
<span>    index_start <span class="op">=</span> <span class="cn">NA</span>, index_end <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    out_path <span class="op">=</span> <span class="st">"E:/Stochastic_Outputs"</span><span class="op">)</span></span></code></pre>
<p>This assumes that in the <code>in_path</code> folder, 6 .csv files are present. The <code>file</code> argument indicates the template for those files. In this case we are assuming all the files follow the same template, where <code>:scenario</code> will be replaced by each of the 6 specified scenarios in turn. If the files do not obey such a simple templating, then you can supply a vector of strings for <code>file</code>, to indicate which files; just note there should be either a one-to-one mapping, or a many-to-one mapping between the different scenarios, and the different files indicated.</p>
<p>In this example, there is only one file per scenario; the <code>index_start</code> and <code>index_end</code> arguments are set to <code>NA</code>, and there is no reference to <code>:index</code> in the <code>file</code> template. We will see later multi-file examples where these three fields are changed to describe the sequence of files we are expecting.</p>
<p>The result is that four files are written - below is an abbreviated section of each.</p>
<div class="section level5">
<h5 id="ic-garske_yf_calendar-csv">IC-Garske_YF_calendar.csv<a class="anchor" aria-label="anchor" href="#ic-garske_yf_calendar-csv"></a>
</h5>
<table style="width:100%;" class="table">
<colgroup>
<col width="6%">
<col width="4%">
<col width="7%">
<col width="11%">
<col width="11%">
<col width="12%">
<col width="14%">
<col width="14%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="right">run_id</th>
<th align="right">year</th>
<th align="right">country</th>
<th align="right">cases_novac</th>
<th align="right">dalys_novac</th>
<th align="right">deaths_novac</th>
<th align="right">cases_prevbest</th>
<th align="right">dalys_prevbest</th>
<th align="right">deaths_prevbest</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">2000</td>
<td align="right">24</td>
<td align="right">1219</td>
<td align="right">21388</td>
<td align="right">452</td>
<td align="right">1165</td>
<td align="right">20219</td>
<td align="right">432</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2001</td>
<td align="right">24</td>
<td align="right">1269</td>
<td align="right">22884</td>
<td align="right">471</td>
<td align="right">1199</td>
<td align="right">21353</td>
<td align="right">444</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2002</td>
<td align="right">24</td>
<td align="right">1319</td>
<td align="right">24129</td>
<td align="right">494</td>
<td align="right">1235</td>
<td align="right">22207</td>
<td align="right">461</td>
</tr>
</tbody>
</table>
<p>So here, we have in each row, the cases, deaths and dalys summed over age for a country and calendar year, for each scenario.</p>
</div>
<div class="section level5">
<h5 id="ic-garske_yf_calendar_u5-csv">IC-Garske_YF_calendar_u5.csv<a class="anchor" aria-label="anchor" href="#ic-garske_yf_calendar_u5-csv"></a>
</h5>
<table style="width:100%;" class="table">
<colgroup>
<col width="6%">
<col width="4%">
<col width="7%">
<col width="11%">
<col width="11%">
<col width="12%">
<col width="14%">
<col width="14%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="right">run_id</th>
<th align="right">year</th>
<th align="right">country</th>
<th align="right">cases_novac</th>
<th align="right">dalys_novac</th>
<th align="right">deaths_novac</th>
<th align="right">cases_prevbest</th>
<th align="right">dalys_prevbest</th>
<th align="right">deaths_prevbest</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">2000</td>
<td align="right">24</td>
<td align="right">269</td>
<td align="right">5710</td>
<td align="right">100</td>
<td align="right">215</td>
<td align="right">4541</td>
<td align="right">80</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2001</td>
<td align="right">24</td>
<td align="right">280</td>
<td align="right">6220</td>
<td align="right">105</td>
<td align="right">210</td>
<td align="right">4689</td>
<td align="right">78</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2002</td>
<td align="right">24</td>
<td align="right">290</td>
<td align="right">6564</td>
<td align="right">110</td>
<td align="right">213</td>
<td align="right">4849</td>
<td align="right">80</td>
</tr>
</tbody>
</table>
<p>This is similar to the calendar year, but ages five and above are ignored, when summing over age, so the numbers are all smaller.</p>
</div>
<div class="section level5">
<h5 id="ic-garske_yf_cohort-csv">IC-Garske_YF_cohort.csv<a class="anchor" aria-label="anchor" href="#ic-garske_yf_cohort-csv"></a>
</h5>
<table style="width:100%;" class="table">
<colgroup>
<col width="6%">
<col width="6%">
<col width="7%">
<col width="11%">
<col width="11%">
<col width="12%">
<col width="14%">
<col width="14%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="right">run_id</th>
<th align="right">cohort</th>
<th align="right">country</th>
<th align="right">cases_novac</th>
<th align="right">dalys_novac</th>
<th align="right">deaths_novac</th>
<th align="right">cases_prevbest</th>
<th align="right">dalys_prevbest</th>
<th align="right">deaths_prevbest</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1900</td>
<td align="right">24</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1901</td>
<td align="right">24</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1902</td>
<td align="right">24</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2000</td>
<td align="right">24</td>
<td align="right">3149</td>
<td align="right">44542</td>
<td align="right">1184</td>
<td align="right">774</td>
<td align="right">15763</td>
<td align="right">280</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2001</td>
<td align="right">24</td>
<td align="right">3261</td>
<td align="right">47051</td>
<td align="right">1222</td>
<td align="right">809</td>
<td align="right">16902</td>
<td align="right">284</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2002</td>
<td align="right">24</td>
<td align="right">3384</td>
<td align="right">51399</td>
<td align="right">1269</td>
<td align="right">799</td>
<td align="right">17573</td>
<td align="right">283</td>
</tr>
</tbody>
</table>
<p>The <code>cohort</code> is calculated by subtracting <code>age</code> from <code>year</code>; it asks the question when were people of a certain age in a certain calendar year born. Notice the <code>cohort</code> column instead of <code>year</code>. This model includes 100-year-olds alive in calendar year 2000, so these were born in the year 1900, but no yellow fever cases or deaths for these scenarios are recorded for that birth cohort.</p>
</div>
<div class="section level5">
<h5 id="ic-garske_yf_cohort_u5-csv">IC-Garske_YF_cohort_u5.csv<a class="anchor" aria-label="anchor" href="#ic-garske_yf_cohort_u5-csv"></a>
</h5>
<table style="width:100%;" class="table">
<colgroup>
<col width="6%">
<col width="6%">
<col width="7%">
<col width="11%">
<col width="11%">
<col width="12%">
<col width="14%">
<col width="14%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="right">run_id</th>
<th align="right">cohort</th>
<th align="right">country</th>
<th align="right">cases_novac</th>
<th align="right">dalys_novac</th>
<th align="right">deaths_novac</th>
<th align="right">cases_prevbest</th>
<th align="right">dalys_prevbest</th>
<th align="right">deaths_prevbest</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1996</td>
<td align="right">24</td>
<td align="right">49</td>
<td align="right">1010</td>
<td align="right">18</td>
<td align="right">49</td>
<td align="right">1010</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1997</td>
<td align="right">24</td>
<td align="right">102</td>
<td align="right">2196</td>
<td align="right">38</td>
<td align="right">86</td>
<td align="right">1854</td>
<td align="right">32</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1998</td>
<td align="right">24</td>
<td align="right">160</td>
<td align="right">3626</td>
<td align="right">60</td>
<td align="right">122</td>
<td align="right">2778</td>
<td align="right">45</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1999</td>
<td align="right">24</td>
<td align="right">221</td>
<td align="right">4483</td>
<td align="right">83</td>
<td align="right">152</td>
<td align="right">3086</td>
<td align="right">57</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2000</td>
<td align="right">24</td>
<td align="right">289</td>
<td align="right">6057</td>
<td align="right">108</td>
<td align="right">207</td>
<td align="right">4346</td>
<td align="right">78</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2001</td>
<td align="right">24</td>
<td align="right">297</td>
<td align="right">6915</td>
<td align="right">112</td>
<td align="right">225</td>
<td align="right">5232</td>
<td align="right">84</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2002</td>
<td align="right">234</td>
<td align="right">310</td>
<td align="right">7223</td>
<td align="right">116</td>
<td align="right">234</td>
<td align="right">5464</td>
<td align="right">87</td>
</tr>
</tbody>
</table>
<p>This is similar to birth cohort, but only considering those age 4 or less. Hence, the oldest age group in the year 2000 (where calendar years begin for this model) will be 4, and they were born in 1996, which is the first birth cohort.</p>
</div>
</div>
<div class="section level4">
<h4 id="multiple-files-per-scenario">Multiple files per scenario<a class="anchor" aria-label="anchor" href="#multiple-files-per-scenario"></a>
</h4>
<p>Some groups submit a file per stochastic run, or a file per country. Some have even arbitrarily started a new file when one file has become, say, 10Mb in size. Stoner doesn’t mind at what point the files are split, except that data for two scenarios cannot exist in the same file, and the files that make up a set must be numbered with contiguous integers.</p>
<p>The example below will expect runs numbered from 1 to 200, as indicated with <code>index_start</code> and <code>index_end</code>. Also notice the presence of the <code>:index</code> placeholder in the <code>file</code> stub, which will be replaced with the sequence number when the files are parsed.</p>
<pre><code><span>  <span class="fu"><a href="../reference/stone_stochastic_process.html">stone_stochastic_process</a></span><span class="op">(</span></span>
<span>    con <span class="op">=</span> <span class="va">con</span>,</span>
<span>    modelling_group <span class="op">=</span> <span class="st">"IC-Garske"</span>,</span>
<span>    disease <span class="op">=</span> <span class="st">"YF"</span>,</span>
<span>    touchstone <span class="op">=</span> <span class="st">"201910gavi-4"</span>,</span>
<span>    scenarios <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yf-no-vaccination"</span>, <span class="st">"yf-preventive-bestcase"</span>,</span>
<span>                  <span class="st">"yf-preventive-default"</span>, <span class="st">"yf-routine-bestcase"</span>,</span>
<span>                  <span class="st">"yf-routine-default"</span>, <span class="st">"yf-stop"</span><span class="op">)</span>,</span>
<span>    in_path <span class="op">=</span> <span class="st">"E:/Dropbox/File Requests/IC-Garske"</span>,</span>
<span>    file <span class="op">=</span> <span class="st">":scenario_:index.csv.xz"</span>,</span>
<span>    cert <span class="op">=</span> <span class="st">"certfile"</span>,</span>
<span>    index_start <span class="op">=</span> <span class="fl">1</span>, index_end <span class="op">=</span> <span class="fl">200</span>,</span>
<span>    out_path <span class="op">=</span> <span class="st">"E:/Stochastic_Outputs"</span><span class="op">)</span></span></code></pre>
<p>Some groups might also submit different numbers of files for each scenario. For example, HepB for some groups requires different numbers of countries to be modelled for different scenarios, dependingn on what campaigns were made in those countries. If a group wishes to split their results by country, they will then have different numbers of files per scenario. In this case, <code>index_start</code> and <code>index_end</code> can be vectors, of the same length as the <code>scenarios</code> vector, giving the start and end ids for each scenario.</p>
<p>Stoner can also support a mixture of single and multi-files for different scenarios. For that case, you’ll need vectors for both the <code>file</code> stub, and the <code>index_start</code> and <code>index_end</code> - Stoner will test that whenever the file stub contains <code>:index</code>, the <code>index_start</code> and <code>index_end</code> are specified, otherwise not.</p>
</div>
<div class="section level4">
<h4 id="summing-different-outcomes">Summing different outcomes<a class="anchor" aria-label="anchor" href="#summing-different-outcomes"></a>
</h4>
<p>Some groups provide multiple deaths or cases categories which need to be summed to give the total deaths or cases. The example below uses the optional <code>deaths</code>, <code>cases</code> and <code>dalys</code> arguments, where a vector of outcomes is provided (which must exist in the incoming data, and in the responsibilities for that group and disease too), to be summed to give the final outcome.</p>
<pre><code>  stone_stochastic_process(
    con = con,
    modelling_group = "IC-Garske",
    disease = "YF",
    touchstone = "201910gavi-4",
    scenarios = c("yf-no-vaccination", "yf-preventive-bestcase",
                  "yf-preventive-default", "yf-routine-bestcase",
                  "yf-routine-default", "yf-stop"),
    in_path = "E:/Dropbox/File Requests/IC-Garske",
    file = ":scenario_:index.csv.xz",
    cert = "certfile",
    index_start = 1, index_end = 200,
    out_path = "E:/Stochastic_Outputs"),
    deaths = c("deaths_cat1", "deaths_cat2"),
    cases = c("cases_cat1", "cases_cat2"),
    dalys = "dalys")</code></pre>
</div>
<div class="section level4">
<h4 id="where-run_id-is-not-specified-in-the-csv">Where run_id is not specified in the CSV<a class="anchor" aria-label="anchor" href="#where-run_id-is-not-specified-in-the-csv"></a>
</h4>
<p>Occasionally, a group omit the <code>run_id</code> column in their input data. In practice this only happens when the <code>run_id</code> is specified as part of the filename. To handle this, set the optional <code>runid_from_file</code> argument to <code>TRUE</code> - and in that case, <code>index_start</code> and <code>index_end</code> must be <code>1</code> and <code>200</code> respectively, and <code>:index</code> must be included in the file template for all scenarios (either specified as a vector, or a singleton).</p>
<pre><code>  stone_stochastic_process(
    con = con,
    modelling_group = "IC-Garske",
    disease = "YF",
    touchstone = "201910gavi-4",
    scenarios = c("yf-no-vaccination", "yf-preventive-bestcase",
                  "yf-preventive-default", "yf-routine-bestcase",
                  "yf-routine-default", "yf-stop"),
    in_path = "E:/Dropbox/File Requests/IC-Garske",
    file = ":scenario_:index.csv.xz",
    cert = "certfile",
    index_start = 1, index_end = 200,
    out_path = "E:/Stochastic_Outputs"),
    runid_from_file = TRUE)</code></pre>
</div>
<div class="section level4">
<h4 id="where-disease-is-not-specified">Where disease is not specified<a class="anchor" aria-label="anchor" href="#where-disease-is-not-specified"></a>
</h4>
<p>Some groups have also omitted the constant <code>disease</code> from their stochastic results. This would normally generate a warning but work correctly in any case; to silence the warning, set the optional <code>allow_missing_disease</code> to be <code>TRUE</code>.</p>
<pre><code>  stone_stochastic_process(
    con = con,
    modelling_group = "IC-Garske",
    disease = "YF",
    touchstone = "201910gavi-4",
    scenarios = c("yf-no-vaccination", "yf-preventive-bestcase",
                  "yf-preventive-default", "yf-routine-bestcase",
                  "yf-routine-default", "yf-stop"),
    in_path = "E:/Dropbox/File Requests/IC-Garske",
    file = ":scenario_:index.csv.xz",
    cert = "certfile",
    index_start = 1, index_end = 200,
    out_path = "E:/Stochastic_Outputs"),
    allow_missing_disease = TRUE)</code></pre>
</div>
<div class="section level4">
<h4 id="different-countries-in-different-scenarios">Different countries in different scenarios<a class="anchor" aria-label="anchor" href="#different-countries-in-different-scenarios"></a>
</h4>
<p>As we said, this can occur, with HepB being an example. If this is the case, besides dealing with a different number of files per scenario (if the group split their files by country), there is nothing you need to do for Stoner to process this properly. In the output CSV files, any country for which there is no data for a particular scenario will have <code>NA</code> for those scenarios. Care might be needed in analysis later on in ensuring comparisons or impact calculations only occur where all the values are not <code>NA</code>.</p>
</div>
<div class="section level4">
<h4 id="certificate-validation">Certificate validation<a class="anchor" aria-label="anchor" href="#certificate-validation"></a>
</h4>
<p>When groups upload the parameters for their stochastic runs into Montagu, they are provided with a certificate - a small JSON file providing metadata, and confirmation of the upload information. The certificate should be provided by the group along with the stochastic data files that were produced using the parameters they uploaded.</p>
<p>By default, stoner will verify that the certificate file exists, and checks that the metadata (modelling group, touchstone, disease) on production that match the certificate also match with the arguments you provide when you call stoner_stochastic_process.</p>
<p>Should you be lacking a group’s certificate, but still want to attempt to process the stochastic data, then set the option <code>bypass_cert_check</code> to be TRUE:-</p>
<pre><code>  stone_stochastic_process(
    con = con,
    modelling_group = "IC-Garske",
    disease = "YF",
    touchstone = "201910gavi-4",
    scenarios = c("yf-no-vaccination", "yf-preventive-bestcase",
                  "yf-preventive-default", "yf-routine-bestcase",
                  "yf-routine-default", "yf-stop"),
    in_path = "E:/Dropbox/File Requests/IC-Garske",
    file = ":scenario_:index.csv.xz",
    cert = "",
    index_start = 1, index_end = 200,
    out_path = "E:/Stochastic_Outputs"),
    bypass_cert_check = TRUE)</code></pre>
<p>You can also manually perform validation of a certificate file without processing stochastic data, with the call:-</p>
<pre><code><span>  <span class="fu"><a href="../reference/stone_stochastic_cert_verify.html">stone_stochastic_cert_verify</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"certfile"</span>, <span class="st">"IC-Garske"</span>, <span class="st">"201910gavi-5"</span>, <span class="st">"YF"</span><span class="op">)</span></span></code></pre>
<p>This call will stop with an error if either the modelling group, or the touchstone do not match with the details used to submit the parameter set, and retrieve the <code>certfile</code> provided here.</p>
</div>
</div>
<div class="section level3">
<h3 id="uploading-to-the-annex-database">Uploading to the annex database<a class="anchor" aria-label="anchor" href="#uploading-to-the-annex-database"></a>
</h3>
<div class="section level4">
<h4 id="uploading-after-processing">Uploading after processing<a class="anchor" aria-label="anchor" href="#uploading-after-processing"></a>
</h4>
<p>The processed CSV files can be uploaded to annex automatically, if an additional database connection <code>annex</code> is provided, and the <code>upload_to_annex</code> is set to TRUE. The files will be uploaded after processing.</p>
<pre><code>  stone_stochastic_process(
    con = con,
    modelling_group = "IC-Garske",
    disease = "YF",
    touchstone = "201910gavi-4",
    scenarios = c("yf-no-vaccination", "yf-preventive-bestcase",
                  "yf-preventive-default", "yf-routine-bestcase",
                  "yf-routine-default", "yf-stop"),
    in_path = "E:/Dropbox/File Requests/IC-Garske",
    file = ":scenario_:index.csv.xz",
    cert = "certfile",
    index_start = 1, index_end = 200,
    out_path = "E:/Stochastic_Outputs"),
    upload_to_annex = TRUE,
    annex = annex,
    allow_new_database = FALSE)</code></pre>
<p>If <code>allow_new_database</code> is set to <code>TRUE</code>, then Stoner will try to create the <code>stochastic_file</code> index table on <code>annex</code>; this will only be wanted on the first time of uploading data to a new empty database, so typically, this will be left as <code>FALSE</code>.</p>
<p>The result of uploading is that four new rows will be added to the <code>stochastic_file</code> table, for <a href="example:-" class="uri">example:-</a></p>
<table class="table">
<thead><tr class="header">
<th align="right">id</th>
<th align="left">touchstone</th>
<th align="left">modelling_group</th>
<th align="left">disease</th>
<th align="left">is_cohort</th>
<th align="left">is_under5</th>
<th align="right">version</th>
<th align="left">creation_date</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">201910gavi-4</td>
<td align="left">IC-Garske</td>
<td align="left">YF</td>
<td align="left">FALSE</td>
<td align="left">TRUE</td>
<td align="right">1</td>
<td align="left">2020-08-06</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">201910gavi-4</td>
<td align="left">IC-Garske</td>
<td align="left">YF</td>
<td align="left">TRUE</td>
<td align="left">TRUE</td>
<td align="right">1</td>
<td align="left">2020-08-06</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">201910gavi-4</td>
<td align="left">IC-Garske</td>
<td align="left">YF</td>
<td align="left">FALSE</td>
<td align="left">FALSE</td>
<td align="right">1</td>
<td align="left">2020-08-06</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="left">201910gavi-4</td>
<td align="left">IC-Garske</td>
<td align="left">YF</td>
<td align="left">TRUE</td>
<td align="left">FALSE</td>
<td align="right">1</td>
<td align="left">2020-08-06</td>
</tr>
</tbody>
</table>
<p>Four new tables named in the form <code>stochastic_</code> followed by the <code>id</code> field listed in the table above will also have been made, which are uploaded copies of the final CSV files. If further uploads are made that match the <code>touchstone</code>, <code>modelling_group</code>, <code>disease</code>, <code>is_cohort</code> and <code>is_under5</code>, then the new data will overwrite the existing data, and the <code>version</code> and <code>creation_date</code> in the table above will be updated.</p>
</div>
<div class="section level4">
<h4 id="uploading-separately-from-processing">Uploading separately from processing<a class="anchor" aria-label="anchor" href="#uploading-separately-from-processing"></a>
</h4>
<p>You can also call the <code>stone_stochastic_upload</code> directly, if you have CSV files ready to upload. Call the function as below, to upload a single CSV file. (Vectors for multiple scenarios in one go are not currently supported in the function).</p>
<pre class="stone_stochastic_upload("><code>     file = 'IC-Garske_YF_calendar_u5.csv',
     con = con,
     annex = annex,
     modelling_group = 'IC-Garske',
     disease = 'YF',
     touchstone = '201910gavi-4',
     is_cohort = FALSE,
     is_under5 = TRUE
  )</code></pre>
<p>The filename is treated as arbitrary; <code>is_cohort</code> and <code>is_under5</code> need specifying to describe the data being uploaded. If this is the first ever upload to a new database, then the optional <code>allow_new_database</code> will enable creation of the <code>stochastic_file</code> table.</p>
</div>
<div class="section level4">
<h4 id="the-testing-argument">The testing argument<a class="anchor" aria-label="anchor" href="#the-testing-argument"></a>
</h4>
<p><code>stone_stochastic_process</code> and <code>stone_stochastic_upload</code> both take a <code>testing</code> logical argument; ignore this, as it is only used to as part of the tests, in which a fake annex database is set up.</p>
</div>
<div class="section level4">
<h4 id="database-connections-and-where-to-find-them-">Database connections (and where to find them).<a class="anchor" aria-label="anchor" href="#database-connections-and-where-to-find-them-"></a>
</h4>
<p>We use the <code>vaultr</code> package, and assume that the <code>VAULT_ADDR</code> and <code>VAULT_AUTH_GITHUB_TOKEN</code> environment variables are set up - we won’t go into doing that here.</p>
<p>A read-only connection to the production database is used to validate the outcomes and countries against those in a group’s expectations. To get the connection to production:-</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">vault</span> <span class="op">&lt;-</span> <span class="fu">vaultr</span><span class="fu">::</span><span class="fu">vault_client</span><span class="op">(</span>login <span class="op">=</span> <span class="st">"github"</span><span class="op">)</span></span>
<span>  <span class="va">password</span> <span class="op">&lt;-</span> <span class="va">vault</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="st">"/secret/vimc/database/production/users/readonly"</span><span class="op">)</span><span class="op">$</span><span class="va">password</span></span>
<span>  <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RPostgres</span><span class="fu">::</span><span class="fu"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">Postgres</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                          dbname <span class="op">=</span> <span class="st">"montagu"</span>,</span>
<span>                          host <span class="op">=</span> <span class="st">"production.montagu.dide.ic.ac.uk"</span>,</span>
<span>                          port <span class="op">=</span> <span class="fl">5432</span>, password <span class="op">=</span> <span class="va">password</span>,</span>
<span>                          user <span class="op">=</span> <span class="st">"readonly"</span><span class="op">)</span></span></code></pre></div>
<p>To get a connection to annex:-</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">password</span> <span class="op">&lt;-</span> <span class="va">vault</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="st">"/secret/vimc/annex/users/vimc"</span><span class="op">)</span><span class="op">$</span><span class="va">password</span></span>
<span>  <span class="va">annex</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RPostgres</span><span class="fu">::</span><span class="fu"><a href="https://rpostgres.r-dbi.org/reference/Postgres.html" class="external-link">Postgres</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                          dbname <span class="op">=</span> <span class="st">"montagu"</span>,</span>
<span>                          host <span class="op">=</span> <span class="st">"annex.montagu.dide.ic.ac.uk"</span>,</span>
<span>                          port <span class="op">=</span> <span class="fl">15432</span>,</span>
<span>                          password <span class="op">=</span> <span class="va">password</span>,</span>
<span>                          user <span class="op">=</span> <span class="st">"vimc"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="use-from-within-dettl-future-work">Use from within dettl (future work)<a class="anchor" aria-label="anchor" href="#use-from-within-dettl-future-work"></a>
</h4>
<p>However, rather than acquiring connections as above and manually running ad hoc database queries on annex, it will be better to express imports to annex using <code>dettl</code>. The imports are made a little more complex than usual by the length of time taken to do the data reduction, the RAM they require can be very large, and the possibility that data will be replaced on annex with subsequent versions. Never-the-less, it would be good to have a formal process for uploading data to annex, and <code>dettl</code> would be a good way.</p>
<p>For example:</p>
<ul>
<li>
<code>Extract stage:</code> read meta data, which would contain a list of groups and locations for different stochastic datasets to be processed. Also look up the necessary metadata for those files - responsibilities and outcomes.</li>
<li>
<code>Transform stage:</code> Perform the reduction, producing csv files. We would need <code>dettl</code> to not try to validate the output against specific database tables, since we often need to create those tables on <code>annex</code> as part of the upload.</li>
<li>
<code>Load stage:</code> Perform the uploads on the created csv files, updating the <code>stochastic_file</code> and adding new tables on <code>annex</code>.</li>
</ul>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Wes Hinsley, Rich Fitzjohn, Robert Ashton.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
